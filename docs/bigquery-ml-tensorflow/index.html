<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Queuery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Queuery Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156581645-3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-156581645-3",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Queuery" href="/opensearch.xml"><title data-react-helmet="true">TensorFlow モデルを作る | Queuery</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="TensorFlow モデルを作る | Queuery"><meta data-react-helmet="true" name="description" content="はじめに"><meta data-react-helmet="true" property="og:description" content="はじめに"><meta data-react-helmet="true" property="og:url" content="https://queuery.com/docs/bigquery-ml-tensorflow"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://queuery.com/docs/bigquery-ml-tensorflow"><link rel="stylesheet" href="/styles.05447168.css">
<link rel="preload" href="/styles.5c08f17d.js" as="script">
<link rel="preload" href="/runtime~main.54d8ed7a.js" as="script">
<link rel="preload" href="/main.8cc151df.js" as="script">
<link rel="preload" href="/1.72e98765.js" as="script">
<link rel="preload" href="/2.7889eed3.js" as="script">
<link rel="preload" href="/69.b1be9a9d.js" as="script">
<link rel="preload" href="/72.055517ef.js" as="script">
<link rel="preload" href="/935f2afb.bc788a4f.js" as="script">
<link rel="preload" href="/17896441.f9af0100.js" as="script">
<link rel="preload" href="/70d6878d.2f6a7d9b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Queuery</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Queuery</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Queuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">introduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">MLOps</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ml-test-score">機械学習システムの評価</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">データマネジメント</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management">データマネジメントとは</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management-get-started">データマネジメントの始め方</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-quality">データ品質とは何か</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">BigQuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-style-guide">コーディングスタイル</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-access-controls">アクセス権設定</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-access-controls-groups">グループ設計例</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-statistical-data-validation">データ品質のチェック方針</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-cost-performance-tuning">安い速い旨い 19 の最適化法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-information-schema-jobs">JOBS_BY_* でジョブ警察</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-materialized-views">マテリアライズドビュー</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-data-types-numeric">数値型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-data-types-string-and-bytes">文字列型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-data-types-date-and-time">日時型</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">BigQuery ML</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-ml">おさらい</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-ml-matrix-factorization">Matrix Factorization</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/bigquery-ml-tensorflow">TensorFlow モデルを作る</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">BigQuery Scripting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-scripting-brainfuck">Brainf*ck</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Google ドライブ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/google-drive-design">Google 共有ドライブ設計論</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">TensorFlow モデルを作る</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="はじめに"></a>はじめに<a class="hash-link" href="#はじめに" title="Direct link to heading">#</a></h2><p>BigQuery ML は <a href="https://cloud.google.com/bigquery-ml/docs/making-predictions-with-imported-tensorflow-models" target="_blank" rel="noopener noreferrer">インポートした TensorFlow モデルでの予測</a> ができます。
BigQuery ML で使える TensorFlow モデルを作るために色々なドキュメントを往復したので、まとめておきます。
BigQuery ML を使って TensorFlow モデルを管理できれば、データソースとの転送を省略したり、
モデルや実行環境の管理を BigQuery と Cloud Storage に任せたりできます。</p><p>また SavedModel 形式は、予測に限らず数式を入れたりできるので、brainfuck が実装できるか遊んでみました（敗北）。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="モデルの作り方"></a>モデルの作り方<a class="hash-link" href="#モデルの作り方" title="Direct link to heading">#</a></h2><p><a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-tensorflow" target="_blank" rel="noopener noreferrer">TensorFlow モデルをインポートする CREATE MODEL ステートメント</a> にあるように、BigQuery ML で使える TensorFlow モデルは SavedModel として保存されている必要があります。
SavedModel を実際に作っていきましょう。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="savedmodel-を作る"></a>SavedModel を作る<a class="hash-link" href="#savedmodel-を作る" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="シンプルな-savedmodel-を作る"></a>シンプルな SavedModel を作る<a class="hash-link" href="#シンプルな-savedmodel-を作る" title="Direct link to heading">#</a></h4><p><a href="https://www.tensorflow.org/api_docs/python/tf/saved_model/save" target="_blank" rel="noopener noreferrer">tf.saved_model.save</a> の例から始めましょう。
例では tf.TensorSpec は <code>shape=None</code> と定義されていますが、BigQuery ML から使う場合は必須のようですので、
<code>shape=1</code> とします。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> tensorflow </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> tf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Adder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  @tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_signature</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">TensorSpec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">shape</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">to_export </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">saved_model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">to_export</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/tmp/adder&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## 認証しておけば Google Storage に直接転送できる</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## tf.saved_model.save(to_export, &#x27;gs://tmp/adder&#x27;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="作った-savedmodel-を-bigquery-にインポートする"></a>作った SavedModel を BigQuery にインポートする<a class="hash-link" href="#作った-savedmodel-を-bigquery-にインポートする" title="Direct link to heading">#</a></h4><p><a href="https://cloud.google.com/bigquery-ml/docs/making-predictions-with-imported-tensorflow-models#importing_models" target="_blank" rel="noopener noreferrer">TensorFlow モデルのインポート</a> を参考にモデルをインポートします。
Cloud Storage にある SavedModel を参照できるので、予め転送しておきましょう。
クエリ 1 つでインポートできるのでとてもお手軽です。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">OR</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">REPLACE</span><span class="token plain"> MODEL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  example_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">imported_tf_model OPTIONS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">MODEL_TYPE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;TENSORFLOW&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    MODEL_PATH</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;gs://tmp/adder/*&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="インポートしたモデルを使う"></a>インポートしたモデルを使う<a class="hash-link" href="#インポートしたモデルを使う" title="Direct link to heading">#</a></h4><p><a href="https://cloud.google.com/bigquery-ml/docs/making-predictions-with-imported-tensorflow-models#making_predictions_with_imported_models" target="_blank" rel="noopener noreferrer">インポートした TensorFlow モデルでの予測</a> を参考にモデルで予測します。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ML</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">PREDICT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">MODEL example_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">imported_tf_model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>実行結果。</p><table><thead><tr><th>行</th><th>output_0</th><th>x</th></tr></thead><tbody><tr><td>0</td><td>3.0</td><td>1</td></tr><tr><td>1</td><td>5.0</td><td>2</td></tr><tr><td>2</td><td>7.0</td><td>3</td></tr><tr><td>3</td><td>9.0</td><td>4</td></tr><tr><td>4</td><td>11.0</td><td>5</td></tr><tr><td>5</td><td>13.0</td><td>6</td></tr><tr><td>6</td><td>15.0</td><td>7</td></tr><tr><td>7</td><td>17.0</td><td>8</td></tr><tr><td>8</td><td>19.0</td><td>9</td></tr><tr><td>9</td><td>21.0</td><td>10</td></tr></tbody></table><p>無事に実行できました。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="サポートされている型"></a>サポートされている型<a class="hash-link" href="#サポートされている型" title="Direct link to heading">#</a></h3><p><a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-tensorflow#inputs" target="_blank" rel="noopener noreferrer">サポートされている入力</a> にありますが、再掲します。</p><table><thead><tr><th>TensorFlow 型</th><th>BigQuery ML type</th></tr></thead><tbody><tr><td>tf.int8, tf.int16, tf.int32, tf.int64, tf.uint8, tf.uint16, tf.uint32, tf.uint64</td><td>INT64</td></tr><tr><td>tf.float16, tf.float32, tf.float64, tf.bfloat16</td><td>FLOAT64</td></tr><tr><td>tf.bool</td><td>BOOL</td></tr><tr><td>tf.string</td><td>STRING</td></tr></tbody></table><p>2020 年 2 月 12 日現在、対応している入出力型は限定的なため、BigQuery のデータ型とモデル作成時の型の自由度の差異に注意しましょう。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="tfestimator-を使った-savedmodel-の作り方"></a>tf.estimator を使った SavedModel の作り方<a class="hash-link" href="#tfestimator-を使った-savedmodel-の作り方" title="Direct link to heading">#</a></h3><p><a href="https://cloud.google.com/ml-engine/docs/tensorflow/exporting-for-prediction" target="_blank" rel="noopener noreferrer">予測に使用する SavedModel のエクスポート</a> を参考に、情報を補足します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="tfestimatorboostedtreesclassifier-の-savedmodel-を作る"></a>tf.estimator.BoostedTreesClassifier の SavedModel を作る<a class="hash-link" href="#tfestimatorboostedtreesclassifier-の-savedmodel-を作る" title="Direct link to heading">#</a></h4><p><a href="https://www.tensorflow.org/tutorials/estimator/boosted_trees" target="_blank" rel="noopener noreferrer">Boosted trees using Estimators</a> を参考に作ります。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="データのロード"></a>データのロード<a class="hash-link" href="#データのロード" title="Direct link to heading">#</a></h5><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> numpy </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> np</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> pandas </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> pd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> tensorflow </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> tf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dftrain </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;https://storage.googleapis.com/tf-datasets/titanic/train.csv&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dfeval </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;https://storage.googleapis.com/tf-datasets/titanic/eval.csv&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">y_train </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dftrain</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;survived&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">y_eval </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dfeval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;survived&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="入力値の作成"></a>入力値の作成<a class="hash-link" href="#入力値の作成" title="Direct link to heading">#</a></h5><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NUMERIC_COLUMNS </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;age&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;fare&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">feature_columns </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> feature_name </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> NUMERIC_COLUMNS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  feature_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">feature_column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">numeric_column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">feature_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                           dtype</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NUM_EXAMPLES </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">y_train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">make_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">X</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> n_epochs</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">None</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> shuffle</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_tensor_slices</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">dict</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">X</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> shuffle</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">shuffle</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">NUM_EXAMPLES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## For training, cycle thru dataset as many times as need (n_epochs=None).</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">repeat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">n_epochs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## In memory training doesn&#x27;t use batching.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">batch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">NUM_EXAMPLES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> dataset</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> input_fn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## Training and evaluation input functions.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">train_input_fn </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> make_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dftrain</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">eval_input_fn </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> make_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dfeval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y_eval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> shuffle</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">False</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> n_epochs</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="tfestimator-の作成"></a>tf.estimator の作成<a class="hash-link" href="#tfestimator-の作成" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">est </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">estimator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">BoostedTreesClassifier</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">feature_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                          n_batches_per_layer</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">est</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">train</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">train_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## Eval.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## result = est.evaluate(eval_input_fn)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## print(pd.Series(result))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="savedmodel-の作成"></a>SavedModel の作成<a class="hash-link" href="#savedmodel-の作成" title="Direct link to heading">#</a></h4><p><a href="https://cloud.google.com/ml-engine/docs/tensorflow/exporting-for-prediction#create_serving_graph_during_training" target="_blank" rel="noopener noreferrer">トレーニング中にサービスグラフを作成する</a> にある json_serving_input_fn を使って、export すると BigQuery ML から理想的な形で呼び出すことができます。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">json_serving_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(195, 232, 141)">&quot;&quot;&quot;Build the serving inputs.&quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    inputs </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> feat </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> feature_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">feat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">placeholder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">shape</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token boolean" style="color:rgb(255, 88, 116)">None</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">feat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dtype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">estimator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ServingInputReceiver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">path </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> est</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">export_saved_model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;gs://tmp/btc&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      json_serving_input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="ここが厄介"></a>ここが厄介<a class="hash-link" href="#ここが厄介" title="Direct link to heading">#</a></h5><p>TensorFlow 1.x は tf.placeholder が使えるので上のコードが動作します。
TensorFlow 2.x は tf.placeholder が使えないため、以下の serving_input_fn で Proto Buffers を経由して頑張る必要がありそうです。予め Proto Buffers に変換したテーブルを用意するのが解になってしまいます。他には <a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/core/example" target="_blank" rel="noopener noreferrer">tensorflow/tensorflow/core/example</a> の .proto を JavaScript にコンパイルして UDF を作成すると回避できる可能性があります。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-python codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">serving_input_fn </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">estimator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">build_parsing_serving_input_receiver_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">feature_column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">make_parse_example_spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">feature_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="作った-savedmodel-を-bigquery-にインポートする-1"></a>作った SavedModel を BigQuery にインポートする<a class="hash-link" href="#作った-savedmodel-を-bigquery-にインポートする-1" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">OR</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">REPLACE</span><span class="token plain"> MODEL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  example_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">imported_tf_model OPTIONS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">MODEL_TYPE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;TENSORFLOW&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    MODEL_PATH</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;gs://tmp/btc/1581656284/*&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="インポートしたモデルを使う-1"></a>インポートしたモデルを使う<a class="hash-link" href="#インポートしたモデルを使う-1" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ML</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">PREDICT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">MODEL bigqueryml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">gbdt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> fare</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>実行結果。</p><table><thead><tr><th>行</th><th>all_class_ids</th><th>all_classes</th><th>class_ids</th><th>classes</th><th>logistic</th><th>logits</th><th>probabilities</th><th>age</th><th>fare</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0.001847356558</td><td>-6.292150497</td><td>0.9981526732</td><td>10</td><td>0</td></tr><tr><td></td><td>1</td><td>1</td><td></td><td></td><td></td><td></td><td>0.001847356558</td><td></td><td></td></tr><tr><td>2</td><td>0</td><td>0</td><td>1</td><td>1</td><td>0.9975745082</td><td>6.019282341</td><td>0.00242551649</td><td>80</td><td>30</td></tr><tr><td></td><td>1</td><td>1</td><td></td><td></td><td></td><td></td><td>0.9975745082</td><td></td><td></td></tr></tbody></table><p>動いてそうです。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="brainfuck-を実装する"></a>Brainfuck を実装する<a class="hash-link" href="#brainfuck-を実装する" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="unliftableerror-に敗北"></a>UnliftableError に敗北<a class="hash-link" href="#unliftableerror-に敗北" title="Direct link to heading">#</a></h4><p>実装してみたのですが、循環参照が計算グラフに変換できなさそうなエラーと遭遇して断念しました。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---------------------------------------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UnliftableError                           Traceback (most recent call last)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ipython-input-14-2aa1513a2c78&gt; in &lt;module&gt;()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      1 to_export = Brainfuck()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">----&gt; 2 op = to_export.brainfuck(tf.constant(&#x27;++++++++[&gt;++++[&gt;++&gt;+++&gt;+++&gt;+&lt;&lt;&lt;&lt;-]&gt;+&gt;+&gt;-&gt;&gt;+[&lt;]&lt;-]&gt;&gt;.&gt;---.+++++++..+++.&gt;&gt;.&lt;-.&lt;.+++.------.--------.&gt;&gt;+.&gt;++.&#x27;, shape=(1,)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      3 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      4 with tf.Session() as sess:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      5     print(sess.run(op))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">52 frames</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/ops/op_selector.py in map_subgraph(init_tensor, sources, disallowed_placeholders, visited_ops, op_outputs, add_sources)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    411           &quot;Unable to lift tensor %s because it depends transitively on &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    412           &quot;placeholder %s via at least one path, e.g.: %s&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--&gt; 413           % (repr(init_tensor), repr(op), _path_from(op, init_tensor, sources)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    414     for inp in graph_inputs(op):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    415       op_outputs[inp].add(op)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UnliftableError: Unable to lift tensor &lt;tf.Tensor &#x27;Variable/Initializer/ReadVariableOp:0&#x27; shape=(64,) dtype=int64&gt; because it depends transitively on placeholder &lt;tf.Operation &#x27;add/cond/Identity_1&#x27; type=Placeholder&gt; via at least one path, e.g.: Variable/Initializer/ReadVariableOp (ReadVariableOp) &lt;- strided_slice/_assign (ResourceStridedSliceAssign) &lt;- add_2 (AddV2) &lt;- strided_slice_1 (StridedSlice) &lt;- strided_slice_1/stack_1 (Pack) &lt;- add_1 (AddV2) &lt;- add/cond/Identity_1 (Placeholder)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="先行研究"></a>先行研究<a class="hash-link" href="#先行研究" title="Direct link to heading">#</a></h4><p><a href="https://github.com/akimach/EsotericTensorFlow" target="_blank" rel="noopener noreferrer">EsotericTensorFlow</a> で、Brainfuck の実装が行われています。
しかし、Brainfuck のソースコードを渡して計算モデルを作成するもので、計算モデルにソースコードを渡して実行するインタプリタではなさそうです。
そのため、私は TensorFlow の計算モデルのチューリング完全性を証明することはできませんでした。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="おわりに"></a>おわりに<a class="hash-link" href="#おわりに" title="Direct link to heading">#</a></h2><p>BigQuery ML で使える TensorFlow の SavedModel を作って動作確認しました。
チューリング完全性の証明には至りませんでしたが、BigQuery ML でテンソルグラフ計算や、
BigQuery ML 未リリースの BoostedTreesClassifier を実現できました。
BigQuery ML を使えれば、データとモデルが近い位置におけるメリットと、クエリ拡張性が出るため活用できると良いですね。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/na0fu3y/queuery/edit/master/docs/bigquery-ml-tensorflow.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-12-14T15:26:57.000Z" class="docLastUpdatedAt_1Qna">12/14/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/bigquery-ml-matrix-factorization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Matrix Factorization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/bigquery-scripting-brainfuck"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Brainf*ck »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#はじめに" class="table-of-contents__link">はじめに</a></li><li><a href="#モデルの作り方" class="table-of-contents__link">モデルの作り方</a><ul><li><a href="#savedmodel-を作る" class="table-of-contents__link">SavedModel を作る</a></li><li><a href="#サポートされている型" class="table-of-contents__link">サポートされている型</a></li><li><a href="#tfestimator-を使った-savedmodel-の作り方" class="table-of-contents__link">tf.estimator を使った SavedModel の作り方</a></li><li><a href="#brainfuck-を実装する" class="table-of-contents__link">Brainfuck を実装する</a></li></ul></li><li><a href="#おわりに" class="table-of-contents__link">おわりに</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/data-management">データマネジメントとは</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/bigquery-access-controls">BigQuery アクセス権設定</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://qiita.com/na0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Qiita</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Queuery. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.5c08f17d.js"></script>
<script src="/runtime~main.54d8ed7a.js"></script>
<script src="/main.8cc151df.js"></script>
<script src="/1.72e98765.js"></script>
<script src="/2.7889eed3.js"></script>
<script src="/69.b1be9a9d.js"></script>
<script src="/72.055517ef.js"></script>
<script src="/935f2afb.bc788a4f.js"></script>
<script src="/17896441.f9af0100.js"></script>
<script src="/70d6878d.2f6a7d9b.js"></script>
</body>
</html>