<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Queuery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Queuery Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156581645-3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-156581645-3",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Queuery" href="/opensearch.xml"><title data-react-helmet="true">安い速い旨い 19 の最適化法 | Queuery</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="安い速い旨い 19 の最適化法 | Queuery"><meta data-react-helmet="true" name="description" content="はじめに: Google BigQuery は速くて安い"><meta data-react-helmet="true" property="og:description" content="はじめに: Google BigQuery は速くて安い"><meta data-react-helmet="true" property="og:url" content="https://queuery.com/docs/bigquery-cost-performance-tuning"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://queuery.com/docs/bigquery-cost-performance-tuning"><link rel="stylesheet" href="/styles.05447168.css">
<link rel="preload" href="/styles.5c08f17d.js" as="script">
<link rel="preload" href="/runtime~main.54d8ed7a.js" as="script">
<link rel="preload" href="/main.8cc151df.js" as="script">
<link rel="preload" href="/1.72e98765.js" as="script">
<link rel="preload" href="/2.7889eed3.js" as="script">
<link rel="preload" href="/69.b1be9a9d.js" as="script">
<link rel="preload" href="/72.055517ef.js" as="script">
<link rel="preload" href="/935f2afb.bc788a4f.js" as="script">
<link rel="preload" href="/17896441.f9af0100.js" as="script">
<link rel="preload" href="/8c4d42a0.b1034e72.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Queuery</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Queuery</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Queuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">introduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">MLOps</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ml-test-score">機械学習システムの評価</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">データマネジメント</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management">データマネジメントとは</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management-get-started">データマネジメントの始め方</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-quality">データ品質とは何か</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">BigQuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-style-guide">コーディングスタイル</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-access-controls">アクセス権設定</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-access-controls-groups">グループ設計例</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-statistical-data-validation">データ品質のチェック方針</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/bigquery-cost-performance-tuning">安い速い旨い 19 の最適化法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-information-schema-jobs">JOBS_BY_* でジョブ警察</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-materialized-views">マテリアライズドビュー</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-data-types-numeric">数値型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-data-types-string-and-bytes">文字列型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-data-types-date-and-time">日時型</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">BigQuery ML</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-ml">おさらい</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-ml-matrix-factorization">Matrix Factorization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-ml-tensorflow">TensorFlow モデルを作る</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">BigQuery Scripting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bigquery-scripting-brainfuck">Brainf*ck</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Google ドライブ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/google-drive-design">Google 共有ドライブ設計論</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">安い速い旨い 19 の最適化法</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="はじめに-google-bigquery-は速くて安い"></a>はじめに: Google BigQuery は速くて安い<a class="hash-link" href="#はじめに-google-bigquery-は速くて安い" title="Direct link to heading">#</a></h2><p><a href="https://cloud.google.com/bigquery/" target="_blank" rel="noopener noreferrer">Google BigQuery</a> を使うと、テラバイト程度のデータに対しても、速く安く機械学習の前処理を行うことができます。2019/12/06 現在、<a href="https://aws.amazon.com/redshift" target="_blank" rel="noopener noreferrer">Redshift Spectrum</a> と同じく、オンデマンドクエリはクエリが参照するデータの容量に対して $5/TB が課金されます。その上、Redshift Spectrum より早いのですから、使わない理由がありません。</p><p>その課金形態ゆえ、全データ処理を 1 つのクエリにおさめ、1 クエリで全てが完了するように書くことで料金を最小化できます。テーブル参照を最少クエリ数に留めるため、処理単位でテーブルを入出力するのを避ける必要があります。
ただし、6 時間以内に完了しないクエリは、以下のエラーで停止します。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Operation timed out after 6.0 hours. Consider reducing the amount of work performed by your operation so that it can complete within this limit.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>分離して実行時間を抑える必要はありますが、料金の観点で見たらクエリの連結が先でしょう。クエリチューニングの話は、記事の後半で記載します。</p><p>データ分析 &amp; データベースのクラウドサービスは Redshift や Synapse Analytics、MaxCompute などもありますが料金体系が異なるため、料金最小化の対象外です。</p><p>料金最小化だけでなく、データ品質チェック、データ変換テストについても述べますので、そちらは SQL 利用される方にもご参照いただけます。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bigquery-の上限に引っかからないために"></a>BigQuery の上限に引っかからないために<a class="hash-link" href="#bigquery-の上限に引っかからないために" title="Direct link to heading">#</a></h2><p>割り当てと上限の詳細な説明は<a href="https://cloud.google.com/bigquery/quotas" target="_blank" rel="noopener noreferrer">公式ページ: Quotas and limits</a> をご覧ください。
ここでは 2019/12/18 現在、BigQuery でデータ変換を行う際に引っ掛かる上限を抜粋しています。</p><table><thead><tr><th>クエリジョブ</th><th>上限</th><th>注意点</th></tr></thead><tbody><tr><td>インタラクティブ クエリの同時実行レートの上限</td><td>同時実行クエリ 100 個</td><td>同時に多量のクエリを投げる場合に注意が必要。実行優先度が低いならばバッチクエリにして回避する。</td></tr><tr><td>クエリ実行時間の上限</td><td>6 時間</td><td>他のリソース系例外の方に出くわすことが多い。このエラーが出た時は再実行してみると案外通ったりする。</td></tr><tr><td>解決済みレガシー SQL クエリおよび標準 SQL クエリの最大長</td><td>12 MB</td><td>クエリに大量のデータを埋め込むと発生する。テーブルに切り出して対応する。</td></tr><tr><td>行の最大サイズ</td><td>100 MB</td><td>ARRAY_AGG で起こることが多い。情報量を落としたり、もう一段 GROUP BY してから ARRAY_AGG することで対応する。</td></tr><tr><td>テーブル、クエリ結果、ビュー定義での最大列数</td><td>10,000</td><td>STRUCT や ARRAY を使わずに平らなテーブルを意識して作ると超える。まとめて良さそうなものは STRUCT や ARRAY にまとめると列数が削減できる。</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="まずは公式ドキュメント"></a>まずは公式ドキュメント<a class="hash-link" href="#まずは公式ドキュメント" title="Direct link to heading">#</a></h2><p>これを参考にした上で不足があれば、他の手法を検討してください。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="クエリ-パフォーマンスの最適化の概要"></a><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-overview" target="_blank" rel="noopener noreferrer">クエリ パフォーマンスの最適化の概要</a><a class="hash-link" href="#クエリ-パフォーマンスの最適化の概要" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bigquery-のおすすめの方法-費用を抑える"></a><a href="https://cloud.google.com/bigquery/docs/best-practices-costs" target="_blank" rel="noopener noreferrer">BigQuery のおすすめの方法: 費用を抑える</a><a class="hash-link" href="#bigquery-のおすすめの方法-費用を抑える" title="Direct link to heading">#</a></h3><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="料金の最小化法-11-こ"></a>料金の最小化法 11 こ<a class="hash-link" href="#料金の最小化法-11-こ" title="Direct link to heading">#</a></h2><p>BigQuery のオンデマンドクエリは、一クエリがアクセスするデータ量で課金されます。同じテーブルにアクセスする回数は重要でありません。そのため、アクセス回数を最小化することが、料金最小化の肝になります。
以降は、<a href="https://cloud.google.com/bigquery/docs/best-practices-costs" target="_blank" rel="noopener noreferrer">BigQuery のおすすめの方法: 費用を抑える</a> のうち、オンデマンドクエリに特化し、実践可能な形に落としたものです。他にもこんな方法で安くしてるよ、といったことがあれば、連絡ください。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="中間データが不要な処理は-with-句や-view-を使ってまとめて実行しよう"></a>中間データが不要な処理は WITH 句や VIEW を使ってまとめて実行しよう<a class="hash-link" href="#中間データが不要な処理は-with-句や-view-を使ってまとめて実行しよう" title="Direct link to heading">#</a></h3><p>BigQuery では、<a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#with-clause" target="_blank" rel="noopener noreferrer">WITH 句</a> や <a href="https://cloud.google.com/bigquery/docs/views" target="_blank" rel="noopener noreferrer">VIEW</a> が利用できます。WITH 句はサブクエリを切り出して名前をつけることができるため、サブクエリに比べて読みやすさを維持できます。VIEW も同様ですが、こちらはクエリの永続化ができます。
これらを用いることで、前のクエリの結果を受けて次のクエリを発行する場合や、2 つのクエリが同じテーブルを参照している場合に料金を節約できます。ただ、どちらも参照コストの発生は免れないため、中間データの方が小さい場合には WITH 句や VIEW ではなく、実体テーブルを作ってしまう方が試行錯誤をする際に安く済みます。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="導出可能属性はテーブルから参照しないようにしよう"></a>導出可能属性はテーブルから参照しないようにしよう<a class="hash-link" href="#導出可能属性はテーブルから参照しないようにしよう" title="Direct link to heading">#</a></h3><p>導出可能属性をテーブルに出力することは、計算時間削減の役目を持ちますが、BigQuery で参照するのは料金に響いてきます。WITH 句や VIEW を用いて切り出して導出、参照して導出可能属性の参照コスト分だけ料金を節約できます。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="日付列など導出可能な-1-列はテーブルではなく、関数にしよう"></a>日付列など導出可能な 1 列はテーブルではなく、関数にしよう<a class="hash-link" href="#日付列など導出可能な-1-列はテーブルではなく、関数にしよう" title="Direct link to heading">#</a></h3><p>テーブルにしておくと参照コストがかかりますが、関数にして保管しておくと便利で保管料金もかからず、テーブル参照がないなら呼び出しの際に参照料金もかかりません。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 参照コストがかかる例</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">my_table </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  target_date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_DATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-01-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-12-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">target_date</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 参照コストがかからない例</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">TARGET_DATES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_DATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-01-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-12-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cross-join-は使うときまで待って"></a>CROSS JOIN は使うときまで待って<a class="hash-link" href="#cross-join-は使うときまで待って" title="Direct link to heading">#</a></h3><p>CROSS JOIN は最も効率よくテーブルが膨らみます。膨らむと保存コストがかかるので、クエリの中だけで膨らませて、集計して小さくなったものをテーブルに出力しましょう。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="部分列しか使わないならなるべく小さくしよう"></a>部分列しか使わないならなるべく小さくしよう<a class="hash-link" href="#部分列しか使わないならなるべく小さくしよう" title="Direct link to heading">#</a></h3><p>サブクエリで * 参照する場合、出力時に SELECT して必要な列のみ参照されます。しかし、出力時に使うと宣言した列は、参照されてしまうため、出力時には使う列を明示的に SELECT するようにしましょう。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="部分行しか使わないならパーティショニングしよう"></a>部分行しか使わないならパーティショニングしよう<a class="hash-link" href="#部分行しか使わないならパーティショニングしよう" title="Direct link to heading">#</a></h3><p>全体テーブルは大きいけど、特定の ID を持つ行だけ参照したいケースでは、<a href="https://cloud.google.com/bigquery/docs/partitioned-tables" target="_blank" rel="noopener noreferrer">パーティショニング</a> するのがおすすめです。
2020 年 1 月 22 日現在、以下の 3 つのパーティショニングがサポートされています。</p><ul><li>取り込み時間パーティション分割テーブル: データを取り込んだ（読み込んだ）日付またはデータが着信した日付に基づいてパーティション分割されたテーブル。</li><li>日付 / 時間パーティション分割テーブル: TIMESTAMP 列または DATE 列を基準にしてパーティション分割されたテーブル。</li><li>整数範囲パーティション分割テーブル: INT64 列を基準にしてパーティション分割されたテーブル。</li></ul><p>参照する際の粒度に合わせて選びましょう。取り込み時間ごとに参照する場合には「取り込み時間パーティション分割テーブル」を利用し、日付ごとに参照する場合には「日付 / 時間パーティション分割テーブル」を選びましょう。ID が INT64 型で入っていて、順序通りに参照する場合には「整数範囲パーティション分割テーブル」が良いでしょう。
このようなケースは稀で、同型 8 種類のテーブルをまとめて同じテーブルに入れてあり、それを分割参照したいなどのケースの方が多いのではないでしょうか。そのような場合には、分割用の列を <a href="https://qiita.com/na0/items/2086fd93116ee7ce9a96#bigquery-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92-partitioning-%E3%81%99%E3%82%8B" target="_blank" rel="noopener noreferrer">無理やり DATE 型に変換</a> して「日付 / 時間パーティション分割テーブル」にするのがおすすめです。
以下のような関数で、分割用の列を DATE に変換できます。ただし、分割する際には、1970-01-01 ~ 2159-12-31 の日付でのみパーティショニングされること、一クエリで 1000 個以上のテーブルを同時参照できないことに気をつけましょう。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  TO_PARTITION_DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">s </span><span class="token keyword" style="font-style:italic">ANY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TYPE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DATE_FROM_UNIX_DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">MOD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ABS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">FARM_FINGERPRINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">CAST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">s </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> STRING</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">69396</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  TO_PARTITION_DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;a&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 2129-09-29</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="より小さなデータ構造を選ぼう"></a>より小さなデータ構造を選ぼう<a class="hash-link" href="#より小さなデータ構造を選ぼう" title="Direct link to heading">#</a></h3><p><a href="https://cloud.google.com/bigquery/pricing#data" target="_blank" rel="noopener noreferrer">データ型</a> によってサイズが異なるため、無駄に大きいデータ型を繰り返し利用するとそれだけで料金が増大します。STRING より INT64 を選べないか、INT64 より BOOL を選べないか、1 対多のテーブルを結合した結果なら ARRAY_AGG で繰り返しレコードを減らせないかなどを検討しましょう。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="時間と手間をかけてもいいなら-bigquery-テーブルを-gcs-の-avro-に吐き出し手から読みとる"></a>時間と手間をかけてもいいなら BigQuery テーブルを GCS の avro に吐き出し手から読みとる<a class="hash-link" href="#時間と手間をかけてもいいなら-bigquery-テーブルを-gcs-の-avro-に吐き出し手から読みとる" title="Direct link to heading">#</a></h3><p>AVRO のデータ圧縮に頼る方法です。読み取りの分だけ所要時間が伸びますが、読み取りデータ量を 20 ％程度削減できます。大きいテーブルで如実に効きますが、読み取り時間も伸びるのであまり利用していません。むしろ、BigQuery 以外（Dataflow, Tensorflow）で読み出す時に使います。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="一体多のデータは-array-で保存しておこう"></a>一体多のデータは ARRAY で保存しておこう<a class="hash-link" href="#一体多のデータは-array-で保存しておこう" title="Direct link to heading">#</a></h3><p>一体多のデータを展開して保持しておくと、同じ値のレコードを複数保持することになります。クエリ速度は劣化しますが、参照コストを下げるためには繰り返しのデータを避けましょう。多の方のテーブルを ARRAY(SELECT AS STRUCT * FROM table) して、保存コストを小さくしておくと、実際の参照の際にもお安くなります。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="厳密な分布が要らないならサンプリングしよう"></a>厳密な分布が要らないならサンプリングしよう<a class="hash-link" href="#厳密な分布が要らないならサンプリングしよう" title="Direct link to heading">#</a></h3><p>データが膨大で、母集団全域で分析する必要がないのであれば、適切にサンプリングしてお安く分析しましょう。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="再現性が必要な場合"></a>再現性が必要な場合<a class="hash-link" href="#再現性が必要な場合" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">key</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">MOD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ABS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">FARM_FINGERPRINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="再現性が不要な場合"></a>再現性が不要な場合<a class="hash-link" href="#再現性が不要な場合" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">key</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> RAND</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="where-句に頻出のフィールドはクラスタ化しよう"></a>WHERE 句に頻出のフィールドはクラスタ化しよう<a class="hash-link" href="#where-句に頻出のフィールドはクラスタ化しよう" title="Direct link to heading">#</a></h3><p>詳細は <a href="https://cloud.google.com/bigquery/docs/clustered-tables" target="_blank" rel="noopener noreferrer">クラスタ化テーブルの概要</a> にありますが、手動でつけると、ベストエフォートで参照フィールドを削減してくれます。LIMIT 句を使う時も有効なようです。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="90-日間変更しないようにしよう"></a>90 日間変更しないようにしよう<a class="hash-link" href="#90-日間変更しないようにしよう" title="Direct link to heading">#</a></h3><p>BigQuery は 90 日間変更がないテーブルを長期保存においてくれて保存コストが半分になります。参照は関係ないので、変更だけないように意識しましょう。変更がある場合も、yyyymmdd のプレフィックスで管理する方が良い解決策になり得ます。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="実行時間の最小化法-7-こ"></a>実行時間の最小化法 7 こ<a class="hash-link" href="#実行時間の最小化法-7-こ" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="with-句や-view-より実テーブル"></a>WITH 句や VIEW より実テーブル<a class="hash-link" href="#with-句や-view-より実テーブル" title="Direct link to heading">#</a></h3><p>WITH 句や VIEW は名前付きサブクエリでしかなく、複数回参照するとその回数だけ計算されます。速度を求める場合には、実テーブルに出力しましょう。トレードオフではありますが、出力テーブルが入力テーブルとの 10 倍以下の容量の時には出力するように意識しましょう（後段の試行錯誤、参照を 10 回以上やる体感に基づいてます）。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="複雑な条件のデータ存在確認は-in-句より-exists-句、exists-句より-left-join-句"></a>複雑な条件のデータ存在確認は IN 句より EXISTS 句、EXISTS 句より LEFT JOIN 句<a class="hash-link" href="#複雑な条件のデータ存在確認は-in-句より-exists-句、exists-句より-left-join-句" title="Direct link to heading">#</a></h3><p>データの存在確認をするような時、様々な実行手段があります。定数比較の場合は、IN 句が早いですが、条件が複雑な場合は LEFT JOIN して WHERE primary_key IS NOT NULL などで主キーの存在確認する方が高速な場合もあります。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="with-句の中で多量の集計関数と-join-を使う時は-select-する列を少なくする"></a>WITH 句の中で多量の集計関数と JOIN を使う時は SELECT する列を少なくする<a class="hash-link" href="#with-句の中で多量の集計関数と-join-を使う時は-select-する列を少なくする" title="Direct link to heading">#</a></h3><p>集計関数や JOIN を多量に行うと CPU 時間を使ってしまい、以下のようなエラーが出ます。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Query exceeded resource limits. 60536.97338085516 CPU seconds were used, and this query must use less than 29900.0 CPU seconds.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>多量の集計関数を使う場合には、集約関数の結果と主キーだけを WITH 句から返し、後から結合すると CPU 時間を節約できることがあります。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="厳密解や-window-関数がいらないなら-approx-関数を検討する"></a>厳密解や WINDOW 関数がいらないなら APPROX 関数を検討する<a class="hash-link" href="#厳密解や-window-関数がいらないなら-approx-関数を検討する" title="Direct link to heading">#</a></h3><p>COUNT(DISTINCT column) より APPROX_COUNT_DISTINCT(column) の方が高速に動作します。他にも、PERCENTILE_CONT(0.5, column) の代わりに APPROX_QUANTILES(x, 2)[OFFSET(1)] を選ぶなどでクエリの高速化ができます。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dau-や-mau-などの粒度だけ異なる-group-by-で厳密な値がいらない場合は、hyperlogloghll-を検討する"></a>DAU や MAU などの粒度だけ異なる GROUP BY で厳密な値がいらない場合は、HyperLogLog++(HLL++) を検討する<a class="hash-link" href="#dau-や-mau-などの粒度だけ異なる-group-by-で厳密な値がいらない場合は、hyperlogloghll-を検討する" title="Direct link to heading">#</a></h3><p>HLL++ は近似計算をしてくれます。厳密な値が必要でない場合、この関数を使うと WINDOW 関数や GROUP BY で対応するのに比べて高速に動作します。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> DATE_SUB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">DAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> date_grp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> HLL_COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">MERGE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sketch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> unique_90_day_users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> HLL_COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">MERGE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">31</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">sketch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> unique_30_day_users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> HLL_COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">MERGE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">sketch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> unique_7_day_users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> window_days</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">creation_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> HLL_COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">INIT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">owner_user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> sketch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">bigquery</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token keyword" style="font-style:italic">public</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stackoverflow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">posts_questions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> EXTRACT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">YEAR</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> creation_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">2017</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">90</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">HAVING</span><span class="token plain"> window_days</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">90</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> date_grp</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="https://stackoverflow.com/questions/49852357/rolling-90-days-active-users-in-bigquery-improving-preformance-dau-mau-wau/49866033#49866033" target="_blank" rel="noopener noreferrer">Rolling 90 days active users in BigQuery, improving preformance (DAU/MAU/WAU)</a> より引用。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="多体一のデータは結合して保管しておこう"></a>多体一のデータは結合して保管しておこう<a class="hash-link" href="#多体一のデータは結合して保管しておこう" title="Direct link to heading">#</a></h3><p>JOIN 回数が多いものは、結合して管理しておくと高速です。繰り返し同じレコードを持つので、参照コストは大きくなりがちですが、クエリ自体が高速に実行できます。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="where-句に頻出のフィールドはクラスタ化しよう-1"></a>WHERE 句に頻出のフィールドはクラスタ化しよう<a class="hash-link" href="#where-句に頻出のフィールドはクラスタ化しよう-1" title="Direct link to heading">#</a></h3><p>詳細は <a href="https://cloud.google.com/bigquery/docs/clustered-tables" target="_blank" rel="noopener noreferrer">クラスタ化テーブルの概要</a> にありますが、階層構造を暗黙的にもっているものなどは、自動的に付くものより手動でつけた方が有効です。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bigquery-でデータクレンジング例"></a>BigQuery でデータクレンジング例<a class="hash-link" href="#bigquery-でデータクレンジング例" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="性別の表現を揃える"></a>性別の表現を揃える<a class="hash-link" href="#性別の表現を揃える" title="Direct link to heading">#</a></h3><p>0, 1 のデータを文字の &#x27;男&#x27;, &#x27;女&#x27; に直しつつ、例外値を NULL に変換します。
CASE 文で条件分岐するだけです。ELSE は省略しても NULL が入ります。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">CASE</span><span class="token plain"> gender</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;男&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;女&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="誕生日の異常領域を削除する"></a>誕生日の異常領域を削除する<a class="hash-link" href="#誕生日の異常領域を削除する" title="Direct link to heading">#</a></h3><p>誕生日の下側を 5％ 落としつつ、上側を現在の日付で落とします。
独自の計測結果では CASE 文より IF 文の方が高速なので、分岐が 1 回だけなら IF を利用しています。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  BIRTH_DATE_PERCENTILE_5_100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      APPROX_QUANTILES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">OFFSET</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">user_master</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">BIRTH_DATE_PERCENTILE_5_100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain">birth_date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">AND</span><span class="token plain"> birth_date</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">DATE_SUB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">CURRENT_DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">YEAR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="異常な郵便番号を正規表現で除去する"></a>異常な郵便番号を正規表現で除去する<a class="hash-link" href="#異常な郵便番号を正規表現で除去する" title="Direct link to heading">#</a></h3><p>数字 7 桁以外は NULL にします。
正規表現でスキーマチェックするのはデータチェックの鉄板です。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">REGEXP_CONTAINS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">zip_code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;^\\d{{7}}$&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    zip_code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bigquery-で特徴量加工例"></a>BigQuery で特徴量加工例<a class="hash-link" href="#bigquery-で特徴量加工例" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="毎日の-sum-を見る"></a>毎日の SUM を見る<a class="hash-link" href="#毎日の-sum-を見る" title="Direct link to heading">#</a></h3><p>単純に GROUP BY すると、穴があいて、特徴量として使いにくいケースがあるため、固定長の配列に JOIN して固定長にしています。DATETIME を DATE にダウンキャストしていますが、JOIN 条件では、情報量が適切に落とされるかやアップキャストの方が適切かなどを確認しながらクエリを書きましょう。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  dt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sales_amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_DATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-01-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2019-02-01&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">dt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ON</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  dt</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  dt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="group-ごとにサンプリング"></a>GROUP ごとにサンプリング<a class="hash-link" href="#group-ごとにサンプリング" title="Direct link to heading">#</a></h3><p>PARTITION BY の中のグループごとに、約 10000 件ずつサンプリング（復元抽出）します。
機械学習でサンプリングが前提なのであれば、テーブル出力前にサンプリングしておくと保存や参照の料金が安く済みます。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">OVER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> week</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">f</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pos</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CROSS</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RAND</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">f</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="データクレンジングから特徴量生成まで-1-クエリでやってみる"></a>データクレンジングから特徴量生成まで 1 クエリでやってみる<a class="hash-link" href="#データクレンジングから特徴量生成まで-1-クエリでやってみる" title="Direct link to heading">#</a></h2><p>元のデータから、機械学習に投入する前まで 1 クエリでできるんじゃないかなと思えてきませんか。
user_master と pos テーブルから RFM 分析を行い、特徴量として結合してみましょう。
長いクエリなので無理して読む必要はありません。単純に WITH 句でつないでいくだけで、データクレンジングから特徴量生成まで 1 クエリになるんだなーと思っていただければ良いです。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="やってみたクエリは長いけれど速くて安い"></a>やってみたクエリは長いけれど速くて安い<a class="hash-link" href="#やってみたクエリは長いけれど速くて安い" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 誕生日の 5% 点を見つける関数</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 外れ値の除去に利用する</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  birth_date_percentile_5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      APPROX_QUANTILES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">OFFSET</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mydataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dirty_user_master</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WITH</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- ユーザ情報をきれいにしたテーブル</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定する主キー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- gender: 性別、&#x27;男&#x27; か &#x27;女&#x27; か NULL を持つ。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- birth_date: 5% 点と 18 歳以上でクレンジングした誕生日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- zip_code: ハイフンなし 7 桁の郵便番号。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">user_master</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ANY_VALUE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">CASE</span><span class="token plain"> gender</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;男&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;女&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> gender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ANY_VALUE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">birth_date_percentile_5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain">birth_date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">AND</span><span class="token plain"> birth_date</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">DATE_SUB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">CURRENT_DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">YEAR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ANY_VALUE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">REGEXP_CONTAINS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">zip_code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;^\\d{7}$&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        zip_code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">zip_code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    my_dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dirty_user_master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 購買情報をきれいにしたテーブル</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- datetime: 取引日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- amount: 購入金額、返品でマイナスになるのを除去してある。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- item_id: 商品を一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">pos</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">DISTINCT</span><span class="token plain"> user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">DATETIME</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    item_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mydataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dirty_pos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    amount</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- pos から RFM 分析した特徴量テーブル</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- recency: 最新購入日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- frequency: 購買日数。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- monetary: 総購買金額。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">rfm_feature</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">MAX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">recency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">frequency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">monetary</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- pos から商品ごとに RFM 分析した特徴量テーブル用の中間テーブル</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- item_id: 商品を一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- recency: 最新購入日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- frequency: 購買日数。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- monetary: 総購買金額。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">rfm_feature_grouped_by_item</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    item_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">MAX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">recency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">DATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">datetime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">frequency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">monetary</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> item_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- pos から商品ごとに RFM 分析した特徴量テーブル</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定するキー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- rfm_array: 商品ごとに recency, frequency, monetary を算出してまとめた配列。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">rfm_feature_array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ARRAY_AGG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">item_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        recency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        frequency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        monetary</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        item_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">rfm_array</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rfm_feature_grouped_by_item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 機械学習に投入するデータ</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id: ユーザを一意に特定する主キー。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- gender: 性別、&#x27;男&#x27; か &#x27;女&#x27; か NULL を持つ。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- birth_date: 5% 点と 18 歳以上でクレンジングした誕生日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- zip_code: ハイフンなし 7 桁の郵便番号。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- recency: 最新購入日。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- frequency: 購買日数。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- monetary: 総購買金額。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- rfm_array: 商品ごとに recency, frequency, monetary を算出してまとめた配列。</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  gender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  birth_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  zip_code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  recency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  frequency</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  monetary</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rfm_array</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  user_master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rfm_feature</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rfm_feature_array</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="やってみたクエリは速くて安いけれど長くて保守できない"></a>やってみたクエリは速くて安いけれど長くて保守できない<a class="hash-link" href="#やってみたクエリは速くて安いけれど長くて保守できない" title="Direct link to heading">#</a></h3><p>申し訳程度のコメントが付いていても読むの無理そうだなーと感じませんでしたか。
実際、1 クエリにすると料金と速度をある程度改善できますが、保守性を犠牲にしてしまいます。保守性を上げるためにはクエリを分割して Apache Airflow などのワークフローで段階的に投げるか、Apache Beam などの SQL より小さな手続き単位で記述するツールを使うべきです。</p><p>このバランスはとても難しいですが、WITH 句や VIEW ごとに切り出しておいて、ユニットテスト、自動で結合するフレームワークを開発して最安最速かつ最保守性を目指しています。
基本は、開発する物の保守性とのバランスを検討すべきです。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="おわりに-google-bigquery-は速くて安くできるけど"></a>おわりに: Google BigQuery は速くて安くできるけど<a class="hash-link" href="#おわりに-google-bigquery-は速くて安くできるけど" title="Direct link to heading">#</a></h2><p>今回は、クエリの高速化、料金最小化と特徴量作成、まるっと全部 1 クエリにしてみる話をしました。1 クエリにすると、速くて安くできます。しかし、取得するデータを書く用途である SQL で手続きを書くと、保守性が犠牲になってしまうことが分かりました。
各工程は飛び飛びですが、全部 1 クエリにする際、それぞれの要素はとても重要です。ぜひ一度確認してみてください。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/na0fu3y/queuery/edit/master/docs/bigquery-cost-performance-tuning.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-12-14T15:26:57.000Z" class="docLastUpdatedAt_1Qna">12/14/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/bigquery-statistical-data-validation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« データ品質のチェック方針</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/bigquery-information-schema-jobs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">JOBS_BY_* でジョブ警察 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#はじめに-google-bigquery-は速くて安い" class="table-of-contents__link">はじめに: Google BigQuery は速くて安い</a></li><li><a href="#bigquery-の上限に引っかからないために" class="table-of-contents__link">BigQuery の上限に引っかからないために</a></li><li><a href="#まずは公式ドキュメント" class="table-of-contents__link">まずは公式ドキュメント</a><ul><li><a href="#クエリ-パフォーマンスの最適化の概要" class="table-of-contents__link">クエリ パフォーマンスの最適化の概要</a></li><li><a href="#bigquery-のおすすめの方法-費用を抑える" class="table-of-contents__link">BigQuery のおすすめの方法: 費用を抑える</a></li></ul></li><li><a href="#料金の最小化法-11-こ" class="table-of-contents__link">料金の最小化法 11 こ</a><ul><li><a href="#中間データが不要な処理は-with-句や-view-を使ってまとめて実行しよう" class="table-of-contents__link">中間データが不要な処理は WITH 句や VIEW を使ってまとめて実行しよう</a></li><li><a href="#導出可能属性はテーブルから参照しないようにしよう" class="table-of-contents__link">導出可能属性はテーブルから参照しないようにしよう</a></li><li><a href="#日付列など導出可能な-1-列はテーブルではなく、関数にしよう" class="table-of-contents__link">日付列など導出可能な 1 列はテーブルではなく、関数にしよう</a></li><li><a href="#cross-join-は使うときまで待って" class="table-of-contents__link">CROSS JOIN は使うときまで待って</a></li><li><a href="#部分列しか使わないならなるべく小さくしよう" class="table-of-contents__link">部分列しか使わないならなるべく小さくしよう</a></li><li><a href="#部分行しか使わないならパーティショニングしよう" class="table-of-contents__link">部分行しか使わないならパーティショニングしよう</a></li><li><a href="#より小さなデータ構造を選ぼう" class="table-of-contents__link">より小さなデータ構造を選ぼう</a></li><li><a href="#時間と手間をかけてもいいなら-bigquery-テーブルを-gcs-の-avro-に吐き出し手から読みとる" class="table-of-contents__link">時間と手間をかけてもいいなら BigQuery テーブルを GCS の avro に吐き出し手から読みとる</a></li><li><a href="#一体多のデータは-array-で保存しておこう" class="table-of-contents__link">一体多のデータは ARRAY で保存しておこう</a></li><li><a href="#厳密な分布が要らないならサンプリングしよう" class="table-of-contents__link">厳密な分布が要らないならサンプリングしよう</a></li><li><a href="#where-句に頻出のフィールドはクラスタ化しよう" class="table-of-contents__link">WHERE 句に頻出のフィールドはクラスタ化しよう</a></li><li><a href="#90-日間変更しないようにしよう" class="table-of-contents__link">90 日間変更しないようにしよう</a></li></ul></li><li><a href="#実行時間の最小化法-7-こ" class="table-of-contents__link">実行時間の最小化法 7 こ</a><ul><li><a href="#with-句や-view-より実テーブル" class="table-of-contents__link">WITH 句や VIEW より実テーブル</a></li><li><a href="#複雑な条件のデータ存在確認は-in-句より-exists-句、exists-句より-left-join-句" class="table-of-contents__link">複雑な条件のデータ存在確認は IN 句より EXISTS 句、EXISTS 句より LEFT JOIN 句</a></li><li><a href="#with-句の中で多量の集計関数と-join-を使う時は-select-する列を少なくする" class="table-of-contents__link">WITH 句の中で多量の集計関数と JOIN を使う時は SELECT する列を少なくする</a></li><li><a href="#厳密解や-window-関数がいらないなら-approx-関数を検討する" class="table-of-contents__link">厳密解や WINDOW 関数がいらないなら APPROX 関数を検討する</a></li><li><a href="#dau-や-mau-などの粒度だけ異なる-group-by-で厳密な値がいらない場合は、hyperlogloghll-を検討する" class="table-of-contents__link">DAU や MAU などの粒度だけ異なる GROUP BY で厳密な値がいらない場合は、HyperLogLog++(HLL++) を検討する</a></li><li><a href="#多体一のデータは結合して保管しておこう" class="table-of-contents__link">多体一のデータは結合して保管しておこう</a></li><li><a href="#where-句に頻出のフィールドはクラスタ化しよう-1" class="table-of-contents__link">WHERE 句に頻出のフィールドはクラスタ化しよう</a></li></ul></li><li><a href="#bigquery-でデータクレンジング例" class="table-of-contents__link">BigQuery でデータクレンジング例</a><ul><li><a href="#性別の表現を揃える" class="table-of-contents__link">性別の表現を揃える</a></li><li><a href="#誕生日の異常領域を削除する" class="table-of-contents__link">誕生日の異常領域を削除する</a></li><li><a href="#異常な郵便番号を正規表現で除去する" class="table-of-contents__link">異常な郵便番号を正規表現で除去する</a></li></ul></li><li><a href="#bigquery-で特徴量加工例" class="table-of-contents__link">BigQuery で特徴量加工例</a><ul><li><a href="#毎日の-sum-を見る" class="table-of-contents__link">毎日の SUM を見る</a></li><li><a href="#group-ごとにサンプリング" class="table-of-contents__link">GROUP ごとにサンプリング</a></li></ul></li><li><a href="#データクレンジングから特徴量生成まで-1-クエリでやってみる" class="table-of-contents__link">データクレンジングから特徴量生成まで 1 クエリでやってみる</a><ul><li><a href="#やってみたクエリは長いけれど速くて安い" class="table-of-contents__link">やってみたクエリは長いけれど速くて安い</a></li><li><a href="#やってみたクエリは速くて安いけれど長くて保守できない" class="table-of-contents__link">やってみたクエリは速くて安いけれど長くて保守できない</a></li></ul></li><li><a href="#おわりに-google-bigquery-は速くて安くできるけど" class="table-of-contents__link">おわりに: Google BigQuery は速くて安くできるけど</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/data-management">データマネジメントとは</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/bigquery-access-controls">BigQuery アクセス権設定</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://qiita.com/na0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Qiita</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Queuery. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.5c08f17d.js"></script>
<script src="/runtime~main.54d8ed7a.js"></script>
<script src="/main.8cc151df.js"></script>
<script src="/1.72e98765.js"></script>
<script src="/2.7889eed3.js"></script>
<script src="/69.b1be9a9d.js"></script>
<script src="/72.055517ef.js"></script>
<script src="/935f2afb.bc788a4f.js"></script>
<script src="/17896441.f9af0100.js"></script>
<script src="/8c4d42a0.b1034e72.js"></script>
</body>
</html>