<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Queuery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Queuery Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156581645-3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-156581645-3",{})</script><title data-react-helmet="true">BigQuery グループ設計例 | Queuery</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="BigQuery グループ設計例 | Queuery"><meta data-react-helmet="true" name="description" content="アクセス権の設計方法"><meta data-react-helmet="true" property="og:description" content="アクセス権の設計方法"><meta data-react-helmet="true" property="og:url" content="https://queuery.com/docs/bigquery-access-controls-groups"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://queuery.com/docs/bigquery-access-controls-groups"><link rel="stylesheet" href="/styles.e5e64cf7.css">
<link rel="preload" href="/styles.2061f735.js" as="script">
<link rel="preload" href="/runtime~main.dcf58911.js" as="script">
<link rel="preload" href="/main.b2f2dad9.js" as="script">
<link rel="preload" href="/1.c2046979.js" as="script">
<link rel="preload" href="/2.89f7a116.js" as="script">
<link rel="preload" href="/3.0cdb0c07.js" as="script">
<link rel="preload" href="/1be78505.eea2c9ad.js" as="script">
<link rel="preload" href="/77.9f0ceb3b.js" as="script">
<link rel="preload" href="/20ac7829.7db9a6b6.js" as="script">
<link rel="preload" href="/17896441.9d5fe073.js" as="script">
<link rel="preload" href="/4908de82.6123e08a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title">Queuery</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title">Queuery</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Queuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">introduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">MLOps</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ml-test-score">機械学習システムの評価</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">データマネジメント</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management">データマネジメントとは</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-management-get-started">データマネジメントの始め方</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/data-quality">データ品質とは何か</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">BigQuery</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-style-guide">コーディングスタイル</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bigquery-access-controls">アクセス権設定</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/bigquery-access-controls-groups">グループ設計例</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">BigQuery グループ設計例</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="アクセス権の設計方法"></a>アクセス権の設計方法<a aria-hidden="true" tabindex="-1" class="hash-link" href="#アクセス権の設計方法" title="Direct link to heading">#</a></h1><p>組織のアクセス権設計はどうするべきでしょうか。ここでは、最小考慮事項として、リスクアセスメントの紹介と権限グループの例を示すに留めます。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="リスクアセスメントをしよう"></a>リスクアセスメントをしよう<a aria-hidden="true" tabindex="-1" class="hash-link" href="#リスクアセスメントをしよう" title="Direct link to heading">#</a></h2><p>ISO/IEC 27002, ISO/IEC 27018, JIS Q 15001, GDPR を確認して、組織ごとのリスクアセスメントを行いましょう。
やることは単純で、リスク分析と評価、コントロールです。個人情報は白黒決めにくい領域であることに加え、BigQuery ML のような機械学習の出力結果（個人情報でなくても）の倫理も問われることになる時代です。小さな母集団にフィットして出力自体が個人情報となる場合や、個人情報のうち性別以外全てをマスクして企業の採用可否を決めるような機械学習モデルを作ると偏見になる場合、多種多様なリスクを孕んでいます。</p><p>BigQuery の一部の情報が漏れたらどうなるか、モデルの中間出力は偏見を生まないか、リスクを思いつく限り洗い出しましょう。その上で、洗い出したリスクが回避可能か、予防低減可能か複数人で検討しましょう。リスクに関して思考停止せず、機密度合いに応じて権限を小さくできないか検討し続ける環境づくりができると良いです。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="グループを活用しよう"></a>グループを活用しよう<a aria-hidden="true" tabindex="-1" class="hash-link" href="#グループを活用しよう" title="Direct link to heading">#</a></h2><p>人にアクセス権が割り当てられている状態は、ライフサイクルが全く異なる物を同一管理しているため、健全な組織とは言い難いです。グループに権限を与え、ライフサイクルを切り離しましょう。グループにすることで、スケールアウトに強くなります。</p><p>1 つのグループに属すのではなく、複数のグループに跨って属するような運用を認めていただけると、エンジニア的に動きやすいです。プロジェクト A の管理者でありながら、プロジェクト B, C の分析担当者であったりといった縦横の組織構造がある場合に特に有効です。それ以外の場合でも、組織構造にそってグループを作って権限を与えると、権限管理者も例外処理が少なくてすみます。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="プロジェクト横断の階層構造の例"></a>プロジェクト横断の階層構造の例<a aria-hidden="true" tabindex="-1" class="hash-link" href="#プロジェクト横断の階層構造の例" title="Direct link to heading">#</a></h3><p>BigQuery の標準の役職ですが、組織の階層構造にそのまま当てはめることができます。管理者から順々に権限が減っていくので、Cloud IAM を用いて組織レベルやプロジェクト単位で設定するのがおすすめのレイヤになります。</p><table><thead><tr><th align="left">役職</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">BigQuery 管理者</td><td align="left">プロジェクト内のすべてのリソースを管理する権限を提供します。プロジェクト内のすべてのデータを管理でき、プロジェクト内で実行されている他のユーザーのジョブもキャンセルできます。</td></tr><tr><td align="left">BigQuery データ編集者</td><td align="left">データセットのメタデータを読み取り、データセット内のテーブルを一覧表示する。データセットのテーブルを作成、更新、取得、削除する。プロジェクトまたは組織レベルで適用した場合、この役割は新しいデータセットを作成することもできます。</td></tr><tr><td align="left">BigQuery データオーナー</td><td align="left">データセットを読み取り、更新、削除する。 データセットのテーブルを作成、更新、取得、削除する。プロジェクトまたは組織レベルで適用した場合、この役割は新しいデータセットを作成することもできます。</td></tr><tr><td align="left">BigQuery ユーザー</td><td align="left">プロジェクト内でジョブ（クエリを含む）を実行する権限を付与します。ユーザーの役割は、自分が所有するジョブの列挙、自分が所有するジョブのキャンセル、プロジェクト内のデータセットの列挙ができます。また、プロジェクト内に新しいデータセットを作成することもできます。作成者には新しいデータセットに対する bigquery.dataOwner 役割が付与されます。</td></tr><tr><td align="left">BigQuery データ閲覧者</td><td align="left">データセットのメタデータを読み取り、データセット内のテーブルを一覧表示する。データセットのテーブルからデータとメタデータを読み取る。プロジェクトまたは組織レベルで適用した場合、この役割はプロジェクト内のすべてのデータセットを列挙することもできます。ただし、ジョブを実行するためには追加の役割が必要です。</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="データセット横断の案件別アサイン構造の例"></a>データセット横断の案件別アサイン構造の例<a aria-hidden="true" tabindex="-1" class="hash-link" href="#データセット横断の案件別アサイン構造の例" title="Direct link to heading">#</a></h3><p>案件など組織の縦割りに当てはまるような構造です。管理者がいるわけではなく、個別のデータに対して、作成レベルと参照レベルの人がいるような構造です。データセットレイヤの権限設定のため、共有データセットを用いて設定するのがおすすめです。</p><table><thead><tr><th align="left">担当案件</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">お客様 A の担当者</td><td align="left">プロジェクト A 内のデータセット、テーブルの一覧、取得の権限を持ちます。</td></tr><tr><td align="left">お客様 A の受注案件 X の担当者</td><td align="left">プロジェクト A のデータセット X 内のテーブルの作成、更新、削除の権限を持ちます。</td></tr><tr><td align="left">お客様 A の受注案件 Y の担当者</td><td align="left">プロジェクト A のデータセット Y 内のテーブルの作成、更新、削除の権限を持ちます。</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="利用者ごとに振る舞いを変える、データマスキングの例"></a>利用者ごとに振る舞いを変える、データマスキングの例<a aria-hidden="true" tabindex="-1" class="hash-link" href="#利用者ごとに振る舞いを変える、データマスキングの例" title="Direct link to heading">#</a></h3><p>役割横割りチームにフィットする構造です。データを触れる人間を少なくしたい時に使うイメージです。テーブルレイヤの権限設定のため、承認済みビューを用いて設定します。</p><table><thead><tr><th align="left">チーム</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">プライバシ検証チーム</td><td align="left">組織内のテーブルの一覧、作成、更新、取得、削除の権限を持ちます。</td></tr><tr><td align="left">EL チーム</td><td align="left">プライバシ検証、保護作業後の承認済みビューの一覧、取得の権限を持ちます。</td></tr><tr><td align="left">分析チーム</td><td align="left">EL 時の作業列を落とした、承認済みビューの一覧、取得の権限を持ちます。</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="アクセス状態によって権限を変える、権限管理の例"></a>アクセス状態によって権限を変える、権限管理の例<a aria-hidden="true" tabindex="-1" class="hash-link" href="#アクセス状態によって権限を変える、権限管理の例" title="Direct link to heading">#</a></h3><p>時限式権限やリソース名などで実行時制約をかけたい時に使います。実行時レイヤの権限設定のため Cloud IAM Conditions を使って設定します。</p><table><thead><tr><th align="left">アカウント</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">社外監査アカウント</td><td align="left">BigQuery データ閲覧者の権限を 1 ヶ月間、9 時から 17 時の間だけ有効にします。</td></tr><tr><td align="left">社外連携アカウント</td><td align="left">案件の検証期間中、Storage の所定のディレクトリに BigQuery エクスポートジョブを投げる権限を持たせます。</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="現状を把握しよう"></a>現状を把握しよう<a aria-hidden="true" tabindex="-1" class="hash-link" href="#現状を把握しよう" title="Direct link to heading">#</a></h2><p>組織に合ったアクセス権設計のために、誰がいつどのように使っているか調査する必要があります。BigQuery と Cloud IAM の現状分析の方法を触りだけ紹介します。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="bigquery-アクセスの現状分析の進め方"></a>BigQuery アクセスの現状分析の進め方<a aria-hidden="true" tabindex="-1" class="hash-link" href="#bigquery-アクセスの現状分析の進め方" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="クエリログをエクスポート-or-ログシンクする"></a>クエリログをエクスポート or ログシンクする<a aria-hidden="true" tabindex="-1" class="hash-link" href="#クエリログをエクスポート-or-ログシンクする" title="Direct link to heading">#</a></h4><p>この辺りを参考に、今までのクエリログを分析可能な状態にします。</p><ul><li><a href="https://cloud.google.com/solutions/exporting-stackdriver-logging-for-security-and-access-analytics?hl=ja#configure_the_logging_export" target="_blank" rel="noopener noreferrer">Stackdriver Logging のエクスポートのためのシナリオ: セキュリティとアクセス解析</a></li><li><a href="https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create" target="_blank" rel="noopener noreferrer">ログビューアによるエクスポート</a></li></ul><p>Stackdriver Logging のエクスポートまたはログシンクの対象は、これくらいで十分です。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource.type=&quot;bigquery_resource&quot; AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">proto_payload.method_name=&quot;jobservice.jobcompleted&quot;</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="誰がどのテーブルにクエリを実行しているか眺める"></a>誰がどのテーブルにクエリを実行しているか眺める<a aria-hidden="true" tabindex="-1" class="hash-link" href="#誰がどのテーブルにクエリを実行しているか眺める" title="Direct link to heading">#</a></h4><p>ログシンクしたテーブルにこのクエリを発行すると、誰がいつ、どのテーブルを触ったのかがわかります。
これで、Cloud IAM と見比べて過剰な権限が付与されていないか確認しましょう。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ADD_PROJECT_ID_IF_NEEDED</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">table_id STRING</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    project_id STRING</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">CASE</span><span class="token plain"> CHAR_LENGTH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">CHAR_LENGTH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">REPLACE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">project_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">WHEN</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"> table_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ERROR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;The format is not supported&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  last_referenced</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  principal_email</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">project_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">dataset_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">table_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> your</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">__TABLES__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protopayload_auditlog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">authenticationInfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">principalEmail principal_email</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ADD_PROJECT_ID_IF_NEEDED</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">REGEXP_REPLACE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[\s`]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      protopayload_auditlog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">servicedata_v1_bigquery</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">jobCompletedEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">jobName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">projectId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">MAX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">timestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">last_referenced</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> your</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">log</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">sync</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">dataset </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cloudaudit_googleapis_com_data_access</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">INNER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">REGEXP_EXTRACT_ALL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">LOWER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">protopayload_auditlog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">servicedata_v1_bigquery</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">jobCompletedEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">jobConfiguration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;(?:from|join)\s*(`(?:[\-\w]+\.)?\w+\.\w+`|(?:[\-\w]+\.)?\w+\.\w+\s|(?:[\-\w]+\.)?\w+\.\w+$)&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">table_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    principal_email</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">table_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="cloud-iam-の現状分析の進め方"></a>Cloud IAM の現状分析の進め方<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cloud-iam-の現状分析の進め方" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="泥臭く頑張る"></a>泥臭く頑張る<a aria-hidden="true" tabindex="-1" class="hash-link" href="#泥臭く頑張る" title="Direct link to heading">#</a></h4><p>組織が拡大していく中で臭うポイントはこれです。</p><ul><li>Cloud IAM の Web UI から過剰に付与された権限がある</li><li>メンバーがデフォルトの役割を持っている or メンバーが継承されていない</li></ul><p>これらを見つけたら過剰な権限の剥奪と、同じ仕事をしている人をグルーピングしてデフォルトじゃない役割を作って付与できないか、継承関係にできないかを考えると良いです。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/na0fu3y/queuery/edit/master/docs/bigquery-access-controls-groups.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-03-21T09:33:40.000Z" class="docLastUpdatedAt_1sqk">3/21/2020</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/bigquery-access-controls"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« BigQuery アクセス権設定</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#リスクアセスメントをしよう" class="table-of-contents__link">リスクアセスメントをしよう</a></li><li><a href="#グループを活用しよう" class="table-of-contents__link">グループを活用しよう</a><ul><li><a href="#プロジェクト横断の階層構造の例" class="table-of-contents__link">プロジェクト横断の階層構造の例</a></li><li><a href="#データセット横断の案件別アサイン構造の例" class="table-of-contents__link">データセット横断の案件別アサイン構造の例</a></li><li><a href="#利用者ごとに振る舞いを変える、データマスキングの例" class="table-of-contents__link">利用者ごとに振る舞いを変える、データマスキングの例</a></li><li><a href="#アクセス状態によって権限を変える、権限管理の例" class="table-of-contents__link">アクセス状態によって権限を変える、権限管理の例</a></li></ul></li><li><a href="#現状を把握しよう" class="table-of-contents__link">現状を把握しよう</a><ul><li><a href="#bigquery-アクセスの現状分析の進め方" class="table-of-contents__link">BigQuery アクセスの現状分析の進め方</a></li><li><a href="#cloud-iam-の現状分析の進め方" class="table-of-contents__link">Cloud IAM の現状分析の進め方</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/data-management">データマネジメントとは</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/bigquery-access-controls">BigQuery アクセス権設定</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://qiita.com/na0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Qiita</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Queuery. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.2061f735.js"></script>
<script src="/runtime~main.dcf58911.js"></script>
<script src="/main.b2f2dad9.js"></script>
<script src="/1.c2046979.js"></script>
<script src="/2.89f7a116.js"></script>
<script src="/3.0cdb0c07.js"></script>
<script src="/1be78505.eea2c9ad.js"></script>
<script src="/77.9f0ceb3b.js"></script>
<script src="/20ac7829.7db9a6b6.js"></script>
<script src="/17896441.9d5fe073.js"></script>
<script src="/4908de82.6123e08a.js"></script>
</body>
</html>