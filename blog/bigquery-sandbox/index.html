<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Queuery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Queuery Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156581645-3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-156581645-3",{})</script><title data-react-helmet="true">BigQuery で 1 円も溶かさない人の顔 (ZERO BYTE STRUCT を考案した) | Queuery</title><meta data-react-helmet="true" property="og:title" content="BigQuery で 1 円も溶かさない人の顔 (ZERO BYTE STRUCT を考案した) | Queuery"><meta data-react-helmet="true" name="description" content="この記事は Qiita と同様の内容です。"><meta data-react-helmet="true" property="og:description" content="この記事は Qiita と同様の内容です。"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.e5e64cf7.css">
<link rel="preload" href="/styles.d1deef8f.js" as="script">
<link rel="preload" href="/runtime~main.8cf8e895.js" as="script">
<link rel="preload" href="/main.ffc40e44.js" as="script">
<link rel="preload" href="/1.73fd05a7.js" as="script">
<link rel="preload" href="/2.34e5ffb9.js" as="script">
<link rel="preload" href="/3.01c33705.js" as="script">
<link rel="preload" href="/ccc49370.b2c5c479.js" as="script">
<link rel="preload" href="/9fb1993a.f0906a4a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title">Queuery</strong></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title">Queuery</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/na0fu3y/queuery" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_2RZH">BigQuery で 1 円も溶かさない人の顔 (ZERO BYTE STRUCT を考案した)</h1><div class="margin-vert--md"><time datetime="2020-01-21T00:00:00.000Z" class="blogPostDate_3tRe">January 21, 2020  · 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/na0fu3y" target="_blank" rel="noreferrer noopener"><img src="https://avatars0.githubusercontent.com/u/17900178?s=400&amp;v=4" alt="Naofumi Yamada"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/na0fu3y" target="_blank" rel="noreferrer noopener">Naofumi Yamada</a></h4><small class="avatar__subtitle">Data Engineer</small></div></div></header><section class="markdown"><p>この記事は <a href="https://qiita.com/na0/items/2086fd93116ee7ce9a96" target="_blank" rel="noopener noreferrer">Qiita</a> と同様の内容です。</p><p>自分は BigQuery で Extract-Load されたデータを機械学習モデル用に前処理し、テラバイト級の特徴量エンジニアリングを行っています。この記事では、BigQuery のデータ量を一切消費せず、誇張なく 1 円も溶かさない裏技をまとめます（2019/12/18 現在）。
ただし、定額クエリやストリーミングインサートは、本記事の対象外です。</p><p>※ パロ元：<a href="https://qiita.com/itkr/items/745d54c781badc148bb9" target="_blank" rel="noopener noreferrer">BigQueryで150万円溶かした人の顔</a>
元ネタの方と同じ職場で働くことになりましたので、被せて書いております。この記事では、BigQuery 記事最安値を目指します。</p><p>速くて安い BigQuery は、データウェアハウスとしても、特徴量エンジニアリングツールとしても優れています。
機械学習モデルを用いたサービスを構築する際には、ベースラインとして候補に挙がるでしょう。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="bigquery-の料金"></a>BigQuery の料金<a aria-hidden="true" tabindex="-1" class="hash-link" href="#bigquery-の料金" title="Direct link to heading">#</a></h1><p>オンデマンドクエリを利用する際、極めて重要なのは読み取りデータ量に対して \$5/TB の料金が発生する点です。これと毎月ストレージコスト \$0.02/GB がかかるだけで、BigQuery の請求が完結する点は恐ろしく明快だと言えます（US (multi-region) 2019/12/18 現在）。 
つまり、読み取るデータ量が小さければ、お財布に優しい料金で膨大な計算を BigQuery に担ってもらえるということです。BigQuery ML もスケール 50 倍ですが、同様の料金体系です。</p><p>料金の詳細な説明は <a href="https://cloud.google.com/bigquery/pricing" target="_blank" rel="noopener noreferrer">公式ページ: BigQuery pricing</a>、<a href="https://cloud.google.com/bigquery-ml/pricing" target="_blank" rel="noopener noreferrer">公式ページ: BigQuery ML pricing</a> をご覧ください。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv0-bigquery-サンドボックスの使用"></a>Lv.0 <a href="https://cloud.google.com/bigquery/docs/sandbox" target="_blank" rel="noopener noreferrer">BigQuery サンドボックスの使用</a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv0-bigquery-サンドボックスの使用" title="Direct link to heading">#</a></h1><p>BigQuery にはサンドボックスと呼ばれる、クレジットカード不要で、無料枠分使える機能が実装されています。
この設定をお試ししつつ、利用額の目安を知ることができます。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv1-unnest-でテーブルを作る"></a>Lv.1 UNNEST でテーブルを作る<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv1-unnest-でテーブルを作る" title="Direct link to heading">#</a></h1><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;a&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;1&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;b&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div></div></div><p>クエリの中で生成されたデータは課金されません。UNNEST でどんな大きなデータを作っても読み取りデータ量は 0 になります。CSV, JSON, AVRO などから、UNNEST のデータに変換するコードを用意しておくと、テスト用データとしても使えるのでおすすめです。</p><p>詳しくは、<a href="https://qiita.com/yancya/items/a1ebe6dbc5d635839cc8" target="_blank" rel="noopener noreferrer">BigQuery で無からリレーションを出現させる（StandardSQL 編）</a>や <a href="https://medium.com/eureka-engineering/bigquery-unnest-100percent-3d28560b4f0" target="_blank" rel="noopener noreferrer">BigqueryでUNNESTを使いこなせ！クエリ効率１００%！！最強！！</a> が参考になります。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv10-create-function--view-で永続データを作る"></a>Lv10. CREATE FUNCTION / VIEW で永続データを作る<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv10-create-function--view-で永続データを作る" title="Direct link to heading">#</a></h1><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">function_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;a&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;1&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;b&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>上の方法と組み合わせて使います。ポイントは永続化できる点です。ARRAY を入れるなら UNNEST して擬似テーブルに、スカラ値を入れるなら、擬似定数として呼び出すことができます。VIEW の場合は、SELECT * FROM UNNEST([]) で保存しましょう。VIEW の中でテーブルを参照すると、クエリの度に読み込みコストが発生するので注意しましょう。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv20-error-でテーブル参照する"></a>Lv20. ERROR でテーブル参照する<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv20-error-でテーブル参照する" title="Direct link to heading">#</a></h1><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ERROR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">TO_JSON_STRING</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> STRUCT </span><span class="token function" style="color:rgb(130, 170, 255)">MAX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">geo_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">MIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">geo_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">bigquery</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token keyword" style="font-style:italic">public</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">census_bureau_acs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">blockgroup_2010_5yr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div></div></div><p>BigQuery は成功したクエリのみ課金されます。つまり絶対に失敗する <code>SELECT ERROR</code> でテーブルを読み取ると課金されません。ERROR 関数は STRING 引数を取れるので、TO_JSON_ARRAY_STRING と ARRAY 関数を組み合わせて、テーブルを JSON で返すようにします。このエラーを各種クライアントの実装からキャッチして、JSON 展開することで、無料のテーブル参照が実現できます。Web コンソールでは、表示文字数に制限があるため、大きなデータを見ることはできません。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv45-カラム名としてデータを保管する"></a>Lv45. カラム名としてデータを保管する<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv45-カラム名としてデータを保管する" title="Direct link to heading">#</a></h1><p>(10 MB 分の課金が発生するので、<strong>0 円ではない</strong> です)
クライアント API からテーブルを作成する際に、カラム名に情報 64 文字(a-zA-Z0-9_)を埋め込み、INFOMATION_SCHEMA 経由で参照する。
STRING を適切に加工することで 10 MB の課金で無制限のデータにアクセスできる。STRING は Lv 100.と違い、データ変換前の列サイズ制約にかかりやすいので注意しましょう。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv70-javascript-で計算する"></a>Lv70. JavaScript で計算する<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv70-javascript-で計算する" title="Direct link to heading">#</a></h1><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">magic_function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x ARRAY</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">INT64</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">RETURNS</span><span class="token plain"> ARRAY</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">INT64</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">LANGUAGE</span><span class="token plain"> js </span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">const memory = new WebAssembly.Memory({ initial: 256, maximum: 256 });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">const env = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">abortStackOverflow</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: _ =&gt; { throw new Error(&#x27;</span><span class="token plain">overflow</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;); },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token keyword" style="font-style:italic">table</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: new WebAssembly.Table({ initial: 0, maximum: 0, element: &#x27;</span><span class="token plain">anyfunc</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; }),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">tableBase</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: 0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">memory</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: memory,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">memoryBase</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: 1024,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">STACKTOP</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: 0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &#x27;</span><span class="token plain">STACK_MAX</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;: memory.buffer.byteLength,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">const imports = { env };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">const bytes = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 139, 128, 128, 128, 0, 2, 96, 1, 127, 0, 96, 2, 127, 127, 1, 127, 2, 254, 128, 128, 128, 0, 7, 3, 101, 110, 118, 8, 83, 84, 65, 67, 75, 84, 79, 80, 3, 127, 0, 3, 101, 110, 118, 9, 83, 84, 65, 67, 75, 95, 77, 65, 88, 3, 127, 0, 3, 101, 110, 118, 18, 97, 98, 111, 114, 116, 83, 116, 97, 99, 107, 79, 118, 101, 114, 102, 108, 111, 119, 0, 0, 3, 101, 110, 118, 6, 109, 101, 109, 111, 114, 121, 2, 1, 128, 2, 128, 2, 3, 101, 110, 118, 5, 116, 97, 98, 108, 101, 1, 112, 1, 0, 0, 3, 101, 110, 118, 10, 109, 101, 109, 111, 114, 121, 66, 97, 115, 101, 3, 127, 0, 3, 101, 110, 118, 9, 116, 97, 98, 108, 101, 66, 97, 115, 101, 3, 127, 0, 3, 130, 128, 128, 128, 0, 1, 1, 6, 147, 128, 128, 128, 0, 3, 127, 1, 35, 0, 11, 127, 1, 35, 1, 11, 125, 1, 67, 0, 0, 0, 0, 11, 7, 136, 128, 128, 128, 0, 1, 4, 95, 115, 117, 109, 0, 1, 9, 129, 128, 128, 128, 0, 0, 10, 196, 128, 128, 128, 0, 1, 190, 128, 128, 128, 0, 1, 7, 127, 2, 64, 35, 4, 33, 8, 35, 4, 65, 16, 106, 36, 4, 35, 4, 35, 5, 78, 4, 64, 65, 16, 16, 0, 11, 32, 0, 33, 2, 32, 1, 33, 3, 32, 2, 33, 4, 32, 3, 33, 5, 32, 4, 32, 5, 106, 33, 6, 32, 8, 36, 4, 32, 6, 15, 0, 11, 0, 11]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">async function main() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  const wa = await WebAssembly.instantiate(bytes, imports);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  const magic_sum = wa.instance.exports._sum;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  return x.map((val) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    return magic_sum(val, val);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">return main();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> magic_function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p><a href="https://stackoverflow.com/questions/57897905/running-async-js-functions-on-bigquery-with-standardsql/57897906#57897906" target="_blank" rel="noopener noreferrer">running async JS functions on BigQuery with #standardSQL</a>なら、web assembly を BigQuery で動かせます。テーブル参照ではないので、普通に SQL 関数を大量に呼ぶのと一緒ではありますが、BigQuery が苦手な再帰関数も JavaScript なら呼べます。web assembly なら、BigQuery の計算時間の範囲内で割と自由に呼びまわせます。
データ参照の方法ではないので、他の手法と組み合わせましょう。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lv100-zero-byte-struct-でテーブルを作る"></a>Lv100. ZERO BYTE STRUCT でテーブルを作る<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lv100-zero-byte-struct-でテーブルを作る" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="定義"></a>定義<a aria-hidden="true" tabindex="-1" class="hash-link" href="#定義" title="Direct link to heading">#</a></h2><p>この記事で使う用語として ZERO BYTE STRUCT を定義します。これは NULL や STRUCT に NULL を入れたデータ、ARRAY に STRUCT(NULL) を入れた状態で、参照コストが 0 であるデータと定義します。後述しますが、BigQuery では NULL の参照コストがかかりません。しかし、NULL と STRUCT(NULL) は明確に区別されます。この仕様により、参照コスト 0 にもかかわらず、1 bit の情報量を持つことができます。</p><p>2019/12/18 現在、データ容量は以下のようになっています。
データサイズな説明は <a href="https://cloud.google.com/bigquery/pricing#data" target="_blank" rel="noopener noreferrer">公式ページ: Pricing Data size calculation</a> をご覧ください。</p><table><thead><tr><th>データの種類</th><th>サイズ</th></tr></thead><tbody><tr><td>INT64/INTEGER</td><td>8 バイト</td></tr><tr><td>FLOAT64/FLOAT</td><td>8 バイト</td></tr><tr><td>NUMERIC</td><td>16 バイト</td></tr><tr><td>BOOL/BOOLEAN</td><td>1 バイト</td></tr><tr><td>STRING</td><td>2 バイト + UTF-8 エンコードされた文字列のサイズ</td></tr><tr><td>BYTES</td><td>2 バイト + 値のバイト数</td></tr><tr><td>DATE</td><td>8 バイト</td></tr><tr><td>DATETIME</td><td>8 バイト</td></tr><tr><td>TIME</td><td>8 バイト</td></tr><tr><td>TIMESTAMP</td><td>8 バイト</td></tr><tr><td>STRUCT/RECORD</td><td>0 バイト + 含まれているフィールドのサイズ</td></tr><tr><td>GEOGRAPHY</td><td>16 バイト + 24 バイト × GEOGRAPHY 型の頂点の数</td></tr></tbody></table><p><strong>どのデータ型でも、null 値は 0 バイトとして計算されます。</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="例"></a>例<a aria-hidden="true" tabindex="-1" class="hash-link" href="#例" title="Direct link to heading">#</a></h2><p>もしお暇な方がいれば以下のクエリを実行し、テーブルに保存し、容量を確認してみてください。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_BOOL_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_INT64_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i INT64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      CONVERT_BOOL_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">u</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">63</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">u</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_INT64_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">1000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">i</span></div></div></div></div></div><p>表のサイズが 0 B になっていることを確認できましたか。それでは戻しましょう。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_BOOL_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_ZERO_BYTE_STRUCT_TO_BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">s STRUCT</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">_ STRUCT</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">INT64</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">_ </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_INT64_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i INT64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      CONVERT_BOOL_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">u</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">63</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">u</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FUNCTION</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_ZERO_BYTE_STRUCT_TO_INT64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">a ARRAY</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">STRUCT</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">_ STRUCT</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">INT64</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="font-style:italic">AS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">CONVERT_ZERO_BYTE_STRUCT_TO_BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">OFFSET</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ARRAY_LENGTH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CONVERT_ZERO_BYTE_STRUCT_TO_INT64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">CONVERT_INT64_TO_ZERO_BYTE_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  UNNEST</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">GENERATE_ARRAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">1000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 先ほどのテーブルを参照する</span></div></div></div></div></div><p>元に戻っていること、課金されるバイト数が 0 B であること確認できたでしょうか。
このように情報を埋め込むことができ、全ての列をこの形に変形すれば、テラバイト情報量を持った 0 バイトテーブルを作成できます。
もちろん ZERO BYTE STRUCT 相互変換に計算時間はかかりますが、これが許容できるのであれば、参照コストなしで無限のデータを扱うことができます。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="zero-byte-struct-functions"></a>ZERO BYTE STRUCT FUNCTIONS<a aria-hidden="true" tabindex="-1" class="hash-link" href="#zero-byte-struct-functions" title="Direct link to heading">#</a></h2><p>ここで自作公開した関数群があるので紹介します。
ZERO BYTE STRUCT 変換関数 <code>bqfunc.zerobyte.(ARRAY_)?{type}_TO_ZEROBYTE</code> です。
この関数は、STRUCT を除く任意の型を ZERO BYTE STRUCT に変換します（{type}が、STRUCT 以外の任意の型に対応します）。
また、逆関数 <code>bqfunc:zerobyte.ZEROBYTE_TO_(ARRAY_)?{type}</code> も用意しました。
STRUCT は個別に関数を組み合わせて作るか、TO_JSON_STRING で詰め込むと良いです。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bqfunc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">zerobyte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">BOOL_TO_ZEROBYTE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">TRUE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="終わりに"></a>終わりに<a aria-hidden="true" tabindex="-1" class="hash-link" href="#終わりに" title="Direct link to heading">#</a></h1><p>ZERO BYTE STRUCT は、BigQuery の課金の抜け穴のようなものですので、実用は避けるべきでしょう。
みんな BigQuery 使おう。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="（追記）"></a>（追記）<a aria-hidden="true" tabindex="-1" class="hash-link" href="#（追記）" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="bigquery-は黒魔術か"></a>BigQuery は黒魔術か<a aria-hidden="true" tabindex="-1" class="hash-link" href="#bigquery-は黒魔術か" title="Direct link to heading">#</a></h2><blockquote class="twitter-tweet"><a href="https://twitter.com/algas/status/1202779751280082944" target="_blank" rel="noopener noreferrer"></a></blockquote><p>黒魔術を使わずとも、他の SQL を触ったことがある方なら、BigQuery は安心してお使いいただけます（言語は PostgreSQL が最も近いかも）。ただ、使い方が違います。従来の SQL はデータを取得するだけのものでしたが、BigQuery は多段のデータ変換まで担わせることでコストパフォーマンスを高めることができます。</p><p>BigQuery 黒魔術の先駆に <a href="https://medium.com/eureka-engineering/bigquery-standard-sql-f13b04c0b6c4" target="_blank" rel="noopener noreferrer">BigqueryStandardSQLの黒魔術ってなに！？記してみました！</a> がいらっしゃいます。ぜひこちらもご覧ください。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="0-円クエリの賛否"></a>0 円クエリの賛否<a aria-hidden="true" tabindex="-1" class="hash-link" href="#0-円クエリの賛否" title="Direct link to heading">#</a></h2><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">BigQuery で 1 円も溶かさない人の顔 (ZERO BYTE STRUCT を考案した) <a href="https://t.co/N23rpUKS32" target="_blank" rel="noopener noreferrer">https://t.co/N23rpUKS32</a> SELECT ERRORで例外キャッチして中身を抜くとかSTRUCT(NULL)をarrayに突っ込んでテーブルサイズの見かけをゼロにするとか…．うーん…</p>— Yuta Kashino (@yutakashino) <a href="https://twitter.com/yutakashino/status/1202877337844568065?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">December 6, 2019</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>利用者への課金が 0 円でも、BigQuery は計算コストを払っていることでしょう。一部分が 0 円で提供されているのは、それでもサービスが全体として成り立つからでしょう。容量用法を守ってお使いください。WHERE 句で IF を使えば条件によって N％ ERROR を返すクエリになりますが、それらが悪かなどの議論は避けます。可能なら、BigQuery としての立場を確認したいところです。(ZERO BYTE STRUCT については、記事の投稿前に GCP へフィードバック送信済みです。)</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/bigquery">bigquery</a></div></footer></article><div><a href="https://github.com/na0fu3y/queuery/edit/master/blog/2020-01-21-bigquery-sandbox.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/bigquery-last-reference-date"><div class="pagination-nav__sublabel">Previous Post</div><div class="pagination-nav__label">« Stackdriver Logging を用いて BigQuery テーブルの最終参照日を求める</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/invisible-service-agent"><div class="pagination-nav__sublabel">Next Post</div><div class="pagination-nav__label">【解決済】Cloud IAM でサービスエージェントから全権限を削除すると見えなくなる »</div></a></div></nav></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/data-management">データマネジメントとは</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/bigquery-access-controls">BigQuery アクセス権設定</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/na0fu3y" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://qiita.com/na0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Qiita</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Queuery. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.d1deef8f.js"></script>
<script src="/runtime~main.8cf8e895.js"></script>
<script src="/main.ffc40e44.js"></script>
<script src="/1.73fd05a7.js"></script>
<script src="/2.34e5ffb9.js"></script>
<script src="/3.01c33705.js"></script>
<script src="/ccc49370.b2c5c479.js"></script>
<script src="/9fb1993a.f0906a4a.js"></script>
</body>
</html>